services:
    _defaults:
        public: true

    threebrs.gopay_payum.gateway_factory:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\GoPayPaymentGatewayFactory

    threebrs.gopay_payum.gateway_factory_builder:
        class: Payum\Core\Bridge\Symfony\Builder\GatewayFactoryBuilder
        arguments:
            - '@threebrs.gopay_payum.gateway_factory'
        tags:
            - { name: 'payum.gateway_factory_builder', factory: 'gopay' }

    threebrs.gopay_payum.api:
        class: ThreeBRS\SyliusGoPayPlugin\Api\GoPayApi
        arguments:
            $gopayPaymentsFactory: '@threebrs.gopay_payum.payments.factory'

    ThreeBRS\SyliusGoPayPlugin\Api\GoPayApiInterface:
        alias: threebrs.gopay_payum.api

    threebrs.gopay_payum.form.type.gateway_configuration:
        class: ThreeBRS\SyliusGoPayPlugin\Form\Type\GoPayPayumGatewayConfigurationType
        tags:
            - { name: 'sylius.gateway_configuration_type', type: 'gopay', label: 'threebrs.gopay_plugin.gateway_label' }
            - { name: 'form.type' }

    threebrs.gopay_payum.action.capture:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Action\CaptureAction
        tags:
            - { name: 'payum.action', factory: 'gopay' }

    threebrs.gopay_payum.action.convert_payment:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Action\ConvertPaymentAction
        tags:
            - { name: 'payum.action', factory: 'gopay' }

    threebrs.gopay_payum.action.gopay:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Action\GoPayAction
        arguments:
            $goPayApi: '@threebrs.gopay_payum.api'
            $payum: '@payum'
            $logger: '@logger'
        tags:
            - { name: 'payum.action', factory: 'gopay' }

    threebrs.gopay_payum.action.notify:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Action\NotifyAction
        arguments:
            $goPayApi: '@threebrs.gopay_payum.api'
            $logger: '@logger'
        tags:
            - { name: 'payum.action', factory: 'gopay' }

    threebrs.gopay_payum.action.refund:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Action\RefundAction
        arguments:
            - '@threebrs.gopay_payum.api'
        tags:
            - { name: 'payum.action', factory: 'gopay' }

    threebrs.gopay_payum.action.cancel:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Action\CancelAction
        arguments:
            - '@threebrs.gopay_payum.api'
        tags:
            - { name: 'payum.action', factory: 'gopay' }

    threebrs.gopay_payum.action.status:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Action\StatusAction
        tags:
            - { name: 'payum.action', factory: 'gopay' }

    threebrs.gopay_payum.state_machine.refund:
        class: ThreeBRS\SyliusGoPayPlugin\StateMachine\RefundOrderProcessor
        arguments:
            $commandBus: '@sylius.command_bus'
        tags:
            - { name: kernel.event_listener, event: workflow.sylius_payment.completed.refund, method: __invoke }

    threebrs.gopay_payum.state_machine.cancel:
        class: ThreeBRS\SyliusGoPayPlugin\StateMachine\CancelOrderProcessor
        arguments:
            $commandBus: '@sylius.command_bus'
        tags:
            - { name: kernel.event_listener, event: workflow.sylius_payment.completed.cancel, method: __invoke }

    threebrs.gopay_payum.command.handler.refund:
        public: true
        class: ThreeBRS\SyliusGoPayPlugin\Message\CommandHandler\RefundPaymentHandler
        arguments:
            $refundRequestFactory: '@threebrs.gopay_payum.request.factory.refund'
            $captureRequestFactory: '@threebrs.gopay_payum.request.factory.capture'
            $payum: '@payum'
            $paymentRepository: '@sylius.repository.payment'
            $supportedGateways: [ 'gopay' ]
        tags:
            -   name: messenger.message_handler
                bus: sylius.command_bus

    threebrs.gopay_payum.command.handler.cancel:
        public: true
        class: ThreeBRS\SyliusGoPayPlugin\Message\CommandHandler\CancelPaymentHandler
        arguments:
            $cancelRequestFactory: '@threebrs.gopay_payum.request.factory.cancel'
            $payum: '@payum'
            $paymentRepository: '@sylius.repository.payment'
            $logger: '@logger'
            $supportedGateways: [ 'gopay' ]
        tags:
            -   name: messenger.message_handler
                bus: sylius.command_bus

    threebrs.gopay_payum.request.factory.capture:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Request\Factory\CaptureRequestFactory

    ThreeBRS\SyliusGoPayPlugin\Payum\Request\Factory\CaptureRequestFactoryInterface:
        alias: threebrs.gopay_payum.request.factory.capture

    threebrs.gopay_payum.request.factory.refund:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Request\Factory\RefundRequestFactory

    ThreeBRS\SyliusGoPayPlugin\Payum\Request\Factory\RefundRequestFactoryInterface:
        alias: threebrs.gopay_payum.request.factory.refund

    threebrs.gopay_payum.request.factory.cancel:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\Request\Factory\CancelRequestFactory

    ThreeBRS\SyliusGoPayPlugin\Payum\Request\Factory\CancelRequestFactoryInterface:
        alias: threebrs.gopay_payum.request.factory.cancel

    threebrs.gopay_payum.payments.factory:
        class: ThreeBRS\SyliusGoPayPlugin\Payum\GoPayPaymentsFactory

    ThreeBRS\SyliusGoPayPlugin\Payum\GoPayPaymentsFactoryInterface:
        alias: threebrs.gopay_payum.payments.factory
